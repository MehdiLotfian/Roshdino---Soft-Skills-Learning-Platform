<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roshdino - Soft Skills Learning Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #2dd4bf 0%, #065f46 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #2dd4bf 0%, #065f46 100%);
        }

        .login-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 400px;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-form h1 {
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #10b981 0%, #065f46 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #84cc16 0%, #365314 100%);
        }

        /* Main Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4a5568;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.5rem;
            color: #10b981;
            animation: ring 2s infinite;
        }

        .notification-bell .notif-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        @keyframes ring {
            0%, 50%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-10deg); }
            20% { transform: rotate(10deg); }
        }

        .points-display {
            background: linear-gradient(135deg, #84cc16 0%, #22c55e 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .progress-categories {
            grid-column: 1 / -1;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: linear-gradient(135deg, #10b981 0%, #065f46 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: scale(1.05);
        }

        .category-card h4 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .category-card .count {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .leaderboard {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-radius: 10px;
            margin-top: 20px;
        }

        .quiz-container {
            grid-column: 1 / -1;
        }

        .question {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .question h4 {
            margin-bottom: 15px;
            color: #4a5568;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .option.selected {
            border-color: #10b981;
            background: #10b981;
            color: white;
        }

        .option input {
            margin-right: 10px;
        }

        .certificate {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #ecfdf5 0%, #bbf7d0 100%);
            border-radius: 15px;
            border: 5px solid #22c55e;
            margin-top: 30px;
        }

        .certificate h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .certificate .seal {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #22c55e 0%, #10b981 100%);
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .training-phase {
            background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.5s ease-out;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(300px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .reward-badge {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: bounceIn 0.8s ease-out;
            z-index: 1001;
            display: none;
        }

        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .game-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: #10b981;
        }

        .game-card.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .role-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .role-card {
            background: linear-gradient(135deg, #10b981 0%, #065f46 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .role-card:hover {
            transform: scale(1.05);
            border-color: #22c55e;
        }

        .role-card.selected {
            border-color: #22c55e;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h1>üê¨ Roshdino</h1>
            <p style="margin-bottom: 30px; color: #718096;">Welcome to the ultimate soft skills learning platform</p>
            
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            
            <div class="form-group">
                <label for="loginRole">Login Role</label>
                <select id="loginRole">
                    <option value="user">User</option>
                    <option value="manager">Manager</option>
                </select>
            </div>
            
            <button class="btn" id="loginBtn">Login</button>
            <button class="btn btn-secondary" id="registerBtn">Register</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="logo">üê¨ Roshdino</div>
                <div class="user-info">
                    <div class="notification-bell" id="notificationBell">üîî<span class="notif-badge" id="notifBadge" style="display:none;">0</span></div>
                    <div class="points-display" id="userPoints">‚≠ê 2,450 Points</div>
                    <div>Welcome, <span id="currentUser">Alex</span> (<span id="currentRole">User</span>)</div>
                    <button class="btn" id="logoutBtn">Logout</button>
                </div>
            </div>

            <!-- Training Phase -->
            <div class="training-phase">
                <h2>üéØ Training Phase Active</h2>
                <p>Complete your training modules before accessing the main contest. Progress: 0%</p>
                <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; margin: 20px 0;">
                    <div style="background: white; height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease;"></div>
                </div>
                <button class="btn" id="startTrainingBtn">Continue Training</button>
            </div>

            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab active" data-tab="game">Game</button>
                <button class="tab" data-tab="leaderboard">Leaderboard</button>
                <button class="tab" id="reportsTab" data-tab="reports" style="display: none;">Reports</button>
                <button class="tab" data-tab="certificate">Certificate</button>
                <button class="tab" id="historyTab" data-tab="history">Quiz History</button>
            </div>

            <!-- Game Tab -->
            <div id="gameTab" class="tab-content active">
                <!-- Game Mode Selection -->
                <div class="game-selection">
                    <div class="game-card" data-mode="practice">
                        <h3>üéÆ Practice Game</h3>
                        <p>Hone your skills in a risk-free environment. Perfect for learning and improvement.</p>
                        <div style="margin-top: 15px; font-size: 2rem;">üîÑ</div>
                    </div>
                    <div class="game-card" data-mode="contest">
                        <h3>üèÜ Main Contest <span id="contestLockIcon" style="display:none; margin-left:8px; font-size:1.2rem; vertical-align:middle;">üîí</span></h3>
                        <p>Compete for points and rankings. Your performance counts towards leaderboard!</p>
                        <div style="margin-top: 15px; font-size: 2rem;">‚ö°</div>
                        <div id="contestLockTooltip" style="display:none; color:#ef4444; font-size:0.95rem; margin-top:10px;">Complete your training to unlock the Main Contest!</div>
                    </div>
                </div>

                <!-- Role Selection -->
                <div id="roleSelection" class="card" style="display: none;">
                    <h3>üé≠ Choose Your Role</h3>
                    <p>Select the role you want to play in this scenario:</p>
                    <div class="role-selection">
                        <div class="role-card" data-role="student">
                            <h4>üéì Student</h4>
                            <p>Learning and growing in your academic journey</p>
                        </div>
                        <div class="role-card" data-role="manager">
                            <h4>üëî Manager</h4>
                            <p>Leading teams and making strategic decisions</p>
                        </div>
                        <div class="role-card" data-role="client">
                            <h4>ü§ù Client</h4>
                            <p>Working with service providers and consultants</p>
                        </div>
                    </div>
                    <button class="btn" id="startGameBtn" style="display: none; margin-top: 20px;">Start Game</button>
                </div>

                <!-- Quiz Questions -->
                <div id="quizSection" class="card quiz-container" style="display: none;">
                    <h3 id="gameTitle">üß† Soft Skills Assessment</h3>
                    <p id="roleContext" style="margin-bottom: 20px; font-style: italic; color: #6b7280;"></p>
                    
                    <div id="questionsContainer">
                        <!-- Questions will be dynamically loaded here -->
                    </div>

                    <button class="btn" id="submitBtn" style="margin-top: 20px;">Submit Quiz</button>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboardTab" class="tab-content">
                <div class="main-content">
                    <!-- Progress Categories -->
                    <div class="card progress-categories">
                        <h3>üìä User Progress Categories</h3>
                        <div class="category-grid" id="progressCategoryGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Leaderboard -->
                    <div class="card leaderboard">
                        <h3>üèÜ Top 5 Players</h3>
                        <div id="top5Leaderboard">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <!-- Your Progress Chart -->
<div class="card chart-container" style="margin-top: 20px;">
    <div style="width: 100%; text-align: center;">
        <h4>üìà Your Progress</h4>
        <p>Track your personal development over the training program</p>
        <div style="background: #e5e7eb; border-radius: 10px; overflow: hidden; height: 30px; margin: 20px auto; width: 80%;">
            <div id="userProgressBar" style="background: linear-gradient(135deg, #10b981, #065f46); height: 100%; width: 0%; color: white; text-align: right; padding-right: 10px; line-height: 30px;">0%</div>
        </div>
    </div>
</div>

                    <!-- Manager-Only Full Leaderboard -->
<div id="fullLeaderboard" class="card" style="display: none;">
    <h3>üìã All Users and Points</h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <thead>
            <tr style="background: #065f46; color: white;">
                <th style="padding: 10px; border: 1px solid #ccc;">#</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Name</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Points</th>
            </tr>
        </thead>
        <tbody id="allUsersTableBody">
            <!-- Populated by JavaScript -->
        </tbody>
    </table>
</div>

<!-- Manager-Only: Overall Progress Over Time -->
<div id="overallProgressChart" class="card chart-container" style="display: none;">
    <div style="width: 100%; text-align: center;">
        <h4>üìä Overall Platform Progress Over Time</h4>
        <p>Weekly user engagement and completion rates</p>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
            <div style="width: 60px; background: linear-gradient(#10b981, #065f46); height: 85px; border-radius: 10px; color: white; display: flex; align-items: flex-end; justify-content: center;">85%</div>
            <div style="width: 60px; background: linear-gradient(#10b981, #065f46); height: 92px; border-radius: 10px; color: white; display: flex; align-items: flex-end; justify-content: center;">92%</div>
            <div style="width: 60px; background: linear-gradient(#10b981, #065f46); height: 70px; border-radius: 10px; color: white; display: flex; align-items: flex-end; justify-content: center;">70%</div>
            <div style="width: 60px; background: linear-gradient(#10b981, #065f46); height: 78px; border-radius: 10px; color: white; display: flex; align-items: flex-end; justify-content: center;">78%</div>
        </div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; color: #4b5563;">
            <div style="width: 60px; text-align: center;">Week 1</div>
            <div style="width: 60px; text-align: center;">Week 2</div>
            <div style="width: 60px; text-align: center;">Week 3</div>
            <div style="width: 60px; text-align: center;">Week 4</div>
        </div>
    </div>
</div>


                </div>
            </div>

            <!-- Reports Tab (Manager Only) -->
            <div id="reportsContentTab" class="tab-content">
                <div id="managerReportsContent">
                    <div id="managerReportsSummary"></div>
                    <canvas id="progressDistChart" style="max-width: 600px; margin: 20px auto;"></canvas>
                    <canvas id="learningTrendsChart" style="max-width: 600px; margin: 20px auto;"></canvas>
                    <div id="managerReportsDetails"></div>
                </div>
            </div>

            <!-- Certificate Tab -->
            <div id="certificateTab" class="tab-content">
                <div class="certificate" id="certificateContent">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Quiz History Tab -->
            <div id="quizHistoryTab" class="tab-content">
                <div class="card">
                    <h3>üìù Quiz History</h3>
                    <div id="quizHistoryContainer">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Popup -->
    <div id="notificationPopup" class="notification-popup" style="display: none; min-width: 320px; max-width: 400px;">
        <div id="notificationList"><strong>Loading notifications...</strong></div>
    </div>

    <!-- Reward Badge -->
    <div id="rewardBadge" class="reward-badge">
        <h3>üéâ Congratulations!</h3>
        <p>You've earned the "Communication Expert" badge!</p>
        <div style="font-size: 3rem; margin: 20px 0;">üê¨</div>
        <button class="btn" id="closeRewardBtn">Awesome!</button>
    </div>

    <script src="/chart.min.js"></script>
    <script>
    let currentUser = 'Alex';
    let currentLoginRole = 'User';
    let currentGameRole = '';
    let currentGameMode = '';
    let userPoints = 0;
    let currentQuestions = [];
    let currentQuizId = '';

    // Tab switching (global definition)
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab
        let tabId = tabName === 'reports' ? 'reportsContentTab' : tabName + 'Tab';
        document.getElementById(tabId).classList.add('active');

        // Activate the correct tab button
        document.querySelectorAll('.tab').forEach(tab => {
            if (tab.dataset.tab === tabName) {
                tab.classList.add('active');
            }
        });
    }

    // Login function
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('loginRole').value;

        if (!username || !password) {
            alert('Please enter username and password');
            return;
        }

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password, role })
            });
            const data = await response.json();
            if (data.success) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                currentUser = data.user.firstName || username;
                currentLoginRole = role;
                userPoints = data.user.points || 0;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('currentUser').textContent = currentUser;
                document.getElementById('currentRole').textContent = role.charAt(0).toUpperCase() + role.slice(1);
                document.getElementById('userPoints').textContent = `‚≠ê ${userPoints.toLocaleString()} Points`;
                // Fetch training progress from backend
                await fetchAndRenderTrainingProgress();
                // Show/hide tabs based on role
                if (role === 'manager') {
                    document.getElementById('reportsTab').style.display = 'inline-block';
                    document.getElementById('overallProgressChart').style.display = 'block';
                    document.getElementById('fullLeaderboard').style.display = 'block';
                    const gameTab = document.querySelector('[onclick="showTab(\'game\')"]');
                    const certTab = document.querySelector('[onclick="showTab(\'certificate\')"]');
                    if (gameTab) gameTab.style.display = 'none';
                    if (certTab) certTab.style.display = 'none';
                    populateFullLeaderboard();
                } else if (role === 'user') {
                    document.getElementById('overallProgressChart').style.display = 'none';
                    document.getElementById('reportsTab').style.display = 'none';
                    document.getElementById('fullLeaderboard').style.display = 'none';
                    const gameTab = document.querySelector('[onclick="showTab(\'game\')"]');
                    if (gameTab) gameTab.style.display = 'inline-block';
                }
                showNotification();
            } else {
                alert('Login failed: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Login error:', error);
            alert('Login failed. Please try again.');
        }
    }

    // Fetch and render training progress
    async function fetchAndRenderTrainingProgress() {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
            const response = await fetch('/api/users/profile', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.success && data.user) {
                const progress = Math.round(data.user.trainingProgress || 0);
                const complete = !!data.user.trainingComplete;
                renderTrainingPhase(progress, complete);
            }
        } catch (e) { console.error('Failed to fetch training progress', e); }
    }

    // Render training phase UI
    function renderTrainingPhase(progress, complete) {
        const trainingPhase = document.querySelector('.training-phase');
        const mainContestCard = document.querySelector('.game-card[data-mode="contest"]');
        const lockIcon = document.getElementById('contestLockIcon');
        const lockTooltip = document.getElementById('contestLockTooltip');
        if (!complete) {
            trainingPhase.style.display = 'block';
            trainingPhase.querySelector('p').textContent = `Complete your training modules before accessing the main contest. Progress: ${progress}%`;
            trainingPhase.querySelector('div > div').style.width = progress + '%';
            mainContestCard.classList.add('disabled');
            mainContestCard.style.pointerEvents = 'none';
            mainContestCard.style.opacity = '0.5';
            if (lockIcon) lockIcon.style.display = 'inline';
            if (lockTooltip) lockTooltip.style.display = 'block';
        } else {
            trainingPhase.style.display = 'none';
            mainContestCard.classList.remove('disabled');
            mainContestCard.style.pointerEvents = 'auto';
            mainContestCard.style.opacity = '1';
            if (lockIcon) lockIcon.style.display = 'none';
            if (lockTooltip) lockTooltip.style.display = 'none';
        }
    }

    // Start training (Continue Training/Practice Game)
    function startTraining() {
        // Simulate clicking Practice Game and Student role
        selectGameMode('practice');
        setTimeout(() => {
            selectRole('student');
            setTimeout(() => {
                startGame();
            }, 300);
        }, 300);
    }

    // Logout function
    function logout() {
        // Clear stored data
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        document.getElementById('dashboard').classList.remove('active');
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        resetGame();
    }

    // Register function
    async function register() {
        console.log('Register function called!'); // Debug log
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('loginRole').value;

        console.log('Register form values:', { username, password, role }); // Debug log

        if (!username || !password) {
            alert('‚ùå Please enter both username and password to continue.');
            return;
        }

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    email: username + '@example.com', // Simple email generation
                    firstName: username,
                    lastName: 'User',
                    role: role
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Registration successful! You can now login with your new account.');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } else {
                // Show user-friendly error messages
                let errorMessage = 'Registration failed';
                
                if (data.message) {
                    if (data.message.includes('already exists')) {
                        errorMessage = '‚ùå This username is already taken. Please choose a different username.';
                    } else if (data.message.includes('Validation failed')) {
                        errorMessage = '‚ùå Please check your information and try again.';
                    } else {
                        errorMessage = `‚ùå ${data.message}`;
                    }
                }
                
                if (data.errors && data.errors.length > 0) {
                    errorMessage += '\n\nPlease fix the following:\n' + data.errors.map(err => {
                        if (err.param === 'username') {
                            return '‚Ä¢ Username must be 3-30 characters (letters, numbers, underscores only)';
                        } else if (err.param === 'email') {
                            return '‚Ä¢ Please enter a valid email address';
                        } else if (err.param === 'password') {
                            return '‚Ä¢ Password must be at least 6 characters long';
                        } else if (err.param === 'firstName') {
                            return '‚Ä¢ First name is required';
                        } else if (err.param === 'lastName') {
                            return '‚Ä¢ Last name is required';
                        } else {
                            return `‚Ä¢ ${err.msg}`;
                        }
                    }).join('\n');
                }
                
                alert(errorMessage);
            }
        } catch (error) {
            console.error('Registration error:', error);
            alert('‚ùå Network error. Please check your internet connection and try again.');
        }
    }

    // Game mode selection
    function selectGameMode(mode) {
        currentGameMode = mode;
        
        // Visual feedback for selection
        document.querySelectorAll('.game-card').forEach(card => {
            card.classList.remove('selected');
        });
        // Find the clicked card and add selected class
        document.querySelectorAll('.game-card').forEach(card => {
            if (card.getAttribute('data-mode') === mode) {
                card.classList.add('selected');
            }
        });
        
        // Show role selection after a brief delay
        setTimeout(() => {
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('roleSelection').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }, 500);
    }

    // Role selection
    function selectRole(role) {
        currentGameRole = role;
        
        // Visual feedback for selection
        document.querySelectorAll('.role-card').forEach(card => {
            card.classList.remove('selected');
        });
        // Find the clicked card and add selected class
        document.querySelectorAll('.role-card').forEach(card => {
            if (card.getAttribute('data-role') === role) {
                card.classList.add('selected');
            }
        });
        
        // Show start button
        document.getElementById('startGameBtn').style.display = 'inline-block';
    }

    // Start game
    function startGame() {
                if (!currentGameRole || !currentGameMode) {
            alert('‚ùå Please select both a game mode and a role to start playing.');
            return;
        }

        // Hide role selection and show quiz
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('quizSection').style.display = 'block';
        
        // Update game title and context
        const gameTitle = currentGameMode === 'practice' ? 'üéÆ Practice Game' : 'üèÜ Main Contest';
        document.getElementById('gameTitle').textContent = gameTitle;
        
        const roleContexts = {
            student: "You are playing as a Student. Answer these questions from a student's perspective.",
            manager: "You are playing as a Manager. Consider leadership and team management scenarios.",
            client: "You are playing as a Client. Think about service relationships and professional interactions."
        };
        
        document.getElementById('roleContext').textContent = roleContexts[currentGameRole];
        
        // Load questions for the selected role
        loadQuestions(currentGameRole);
        
        // Scroll to quiz section
        document.getElementById('quizSection').scrollIntoView({ 
            behavior: 'smooth' 
        });
    }

    // Load questions based on role
    async function loadQuestions(role) {
        const token = localStorage.getItem('token');
        const container = document.getElementById('questionsContainer');
        if (!token) {
            container.innerHTML = '<p>Please login to load quizzes.</p>';
            return;
        }
        try {
            const response = await fetch(`/api/quizzes/next?role=${role}&mode=${currentGameMode}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            container.innerHTML = '';
            if (data.success && data.quiz && data.quiz.questions && data.quiz.questions.length > 0) {
                currentQuestions = data.quiz.questions;
                currentQuizId = data.quiz._id;
                currentQuestions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    questionDiv.innerHTML = `
                        <h4>Question ${index + 1}: ${q.question}</h4>
                        <div class="options">
                            ${q.options.map((option, optIndex) => `
                                <div class="option" data-question="${index}" data-option="${optIndex}">
                                    <input type="radio" name="question${index}" value="${optIndex}">
                                    <label>${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(questionDiv);
                });
            } else {
                container.innerHTML = '<p>No quizzes available for this role.</p>';
            }
        } catch (e) {
            container.innerHTML = '<p>Error loading quiz questions.</p>';
        }
    }

    // Submit quiz
    async function submitQuiz() {
        const questions = currentQuestions || [];
        let answeredCount = 0;
        const answers = [];
        
        // Count answered questions and collect answers
        questions.forEach((q, index) => {
            const selected = document.querySelector(`input[name="question${index}"]:checked`);
            if (selected) {
                answeredCount++;
                answers.push(parseInt(selected.value));
            } else {
                answers.push(null);
            }
        });

        if (answeredCount < questions.length) {
            alert(`‚ùå Please answer all ${questions.length} questions before submitting. You have answered ${answeredCount} questions.`);
            return;
        }

        try {
            // Get token for authentication
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                return;
            }

            // Submit quiz to backend
            const submitResponse = await fetch(`/api/quizzes/submit`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quizId: currentQuizId,
                    answers: answers,
                    role: currentGameRole,
                    gameMode: currentGameMode,
                    timeSpent: Math.floor(Math.random() * 300) + 60 // Random time between 1-6 minutes
                })
            });

            const submitData = await submitResponse.json();
            console.log('Quiz submission response:', submitData); // Debug log

            // Robust points update logic
            if (submitData.user && typeof submitData.user.points === 'number') {
                userPoints = submitData.user.points;
                document.getElementById('userPoints').textContent = `‚≠ê ${userPoints.toLocaleString()} Points`;
            } else if (typeof submitData.pointsEarned === 'number') {
                userPoints += submitData.pointsEarned;
                document.getElementById('userPoints').textContent = `‚≠ê ${userPoints.toLocaleString()} Points`;
            }

            if (submitData.success) {
                showGameResults(submitData.score || 0, submitData.pointsEarned || 0);
            } else {
                alert(`‚ùå Quiz submission failed: ${submitData.message || 'Please try again.'}`);
            }

            // Update training progress after quiz
            await fetchAndRenderTrainingProgress();
        } catch (error) {
            console.error('Quiz submission error:', error);
            // Fallback to mock submission
            const score = Math.floor(Math.random() * 30) + 70;
            const pointsEarned = currentGameMode === 'contest' ? score * 10 : Math.floor(score * 5);
            showGameResults(score, pointsEarned);
        }
        
        // Reset game
        setTimeout(() => {
            resetGame();
        }, 5000);
    }

    // Show game results
    function showGameResults(score, points) {
        const quizSection = document.getElementById('quizSection');
        const oldResult = quizSection.querySelector('.quiz-result-card');
        if (oldResult) oldResult.remove();
        const resultDiv = document.createElement('div');
        resultDiv.className = 'card quiz-result-card';
        resultDiv.style.cssText = 'background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; text-align: center; margin-top: 20px;';
        
        resultDiv.innerHTML = `
            <h3>üéâ Quiz Complete!</h3>
            <div style="font-size: 3rem; margin: 20px 0;">üê¨</div>
            <p style="font-size: 1.5rem; margin: 10px 0;"><strong>Score: ${score}%</strong></p>
            <p style="font-size: 1.2rem;">Points Earned: ${points}</p>
            <p style="margin-top: 20px;">Mode: ${currentGameMode === 'contest' ? 'Main Contest' : 'Practice Game'}</p>
            <p>Role: ${currentGameRole.charAt(0).toUpperCase() + currentGameRole.slice(1)}</p>
        `;
        
        quizSection.appendChild(resultDiv);
        
        // Show reward badge for high scores
        if (score >= 85) {
            setTimeout(() => {
                document.getElementById('rewardBadge').style.display = 'block';
            }, 1000);
        }
    }

    // Reset game
    function resetGame() {
        currentGameRole = '';
        currentGameMode = '';
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('quizSection').style.display = 'none';
        document.getElementById('startGameBtn').style.display = 'none';
        
        // Clear selections
        document.querySelectorAll('.game-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelectorAll('.role-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Clear quiz results
        const existingResults = document.querySelector('#quizSection .card:last-child');
        if (existingResults && existingResults.style.background.includes('22c55e')) {
            existingResults.remove();
        }
    }

    // Notification functions
    function showNotification() {
        const popup = document.getElementById('notificationPopup');
        popup.style.display = 'block';
        
        setTimeout(() => {
            popup.style.display = 'none';
        }, 3000);
    }

    // Close reward badge
    function closeReward() {
        document.getElementById('rewardBadge').style.display = 'none';
    }

    // Download certificate
    async function fetchCertificate() {
        const token = localStorage.getItem('token');
        const certDiv = document.getElementById('certificateContent');
        if (!token) return;
        try {
            const response = await fetch('/api/certificates', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.success && data.certificates && data.certificates.length > 0) {
                const cert = data.certificates[data.certificates.length-1];
                certDiv.innerHTML = `
                    <h2>üèÜ Certificate of Achievement</h2>
                    <p>This certifies that</p>
                    <h3 style="color: #10b981; margin: 20px 0; font-size: 2.5rem;">${cert.name}</h3>
                    <p>has successfully completed the</p>
                    <h4 style="color: #065f46; margin: 15px 0;">Soft Skills Mastery Program</h4>
                    <div class="seal">üê¨</div>
                    <p>Awarded on: <strong>${new Date(cert.issuedAt).toLocaleDateString()}</strong></p>
                    <p style="margin-top: 20px;">Score: <strong>${cert.score}%</strong></p>
                    <a class="btn" href="${cert.certificateUrl}" target="_blank">Download Certificate</a>
                `;
            } else {
                certDiv.innerHTML = '<p>No certificates yet.</p>';
            }
        } catch (e) { certDiv.innerHTML = '<p>Error loading certificate.</p>'; }
    }

    // Auto-show notification on page load
    window.addEventListener('load', () => {
        console.log('Page loaded! JavaScript is working!'); // Debug log
        setTimeout(() => {
            if (document.getElementById('dashboard').classList.contains('active')) {
                showNotification();
            }
        }, 2000);
    });

    // Add comprehensive event listeners
    window.addEventListener('DOMContentLoaded', () => {
        // Remove forced Quiz History tab activation
        // Default to Game tab on load
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById('gameTab').classList.add('active');
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        const gameBtn = document.querySelector('[data-tab="game"]');
        if (gameBtn) gameBtn.classList.add('active');
    });

    // Login button
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) {
        loginBtn.addEventListener('click', login);
    }

    // Register button
    const registerBtn = document.getElementById('registerBtn');
    if (registerBtn) {
        registerBtn.addEventListener('click', register);
    }

    // Logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }

    // Start training button
    const startTrainingBtn = document.getElementById('startTrainingBtn');
    if (startTrainingBtn) {
        startTrainingBtn.addEventListener('click', startTraining);
    }

    // Tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const tabName = e.target.getAttribute('data-tab');
            if (tabName) {
                showTab(tabName);
                if (tabName === 'history') {
                    fetchQuizHistory();
                    // Ensure the tab content is visible
                    document.getElementById('quizHistoryTab').classList.add('active');
                }
                if (tabName === 'leaderboard') fetchTop5Leaderboard();
            }
        });
    });

    // Game mode selection
    document.querySelectorAll('.game-card').forEach(card => {
        card.addEventListener('click', (e) => {
            const mode = e.currentTarget.getAttribute('data-mode');
            if (mode) {
                selectGameMode(mode);
            }
        });
    });

    // Role selection
    document.querySelectorAll('.role-card').forEach(card => {
        card.addEventListener('click', (e) => {
            const role = e.currentTarget.getAttribute('data-role');
            if (role) {
                selectRole(role);
            }
        });
    });

    // Start game button
    const startGameBtn = document.getElementById('startGameBtn');
    if (startGameBtn) {
        startGameBtn.addEventListener('click', startGame);
    }

    // Submit quiz button
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', submitQuiz);
    }

    // Close reward button
    const closeRewardBtn = document.getElementById('closeRewardBtn');
    if (closeRewardBtn) {
        closeRewardBtn.addEventListener('click', closeReward);
    }

    // Download certificate button
    const downloadCertBtn = document.getElementById('downloadCertBtn');
    if (downloadCertBtn) {
        downloadCertBtn.addEventListener('click', fetchCertificate);
    }

    // Notification bell
    const notificationBell = document.getElementById('notificationBell');
    if (notificationBell) {
        notificationBell.addEventListener('click', showNotification);
    }

    // Add hover effects to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-5px)';
        });
        
        card.addEventListener('mouseleave', () => {
            card.style.transform = 'translateY(0)';
        });
    });

    // Add click effects to buttons
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(button => {
        button.addEventListener('click', (e) => {
            const ripple = document.createElement('div');
            ripple.style.cssText = `
                position: absolute;
                background: rgba(255,255,255,0.6);
                border-radius: 50%;
                transform: scale(0);
                animation: ripple-effect 0.6s linear;
                left: ${e.offsetX - 10}px;
                top: ${e.offsetY - 10}px;
                width: 20px;
                height: 20px;
                pointer-events: none;
            `;
            
            button.style.position = 'relative';
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });

    // Load quiz history
    async function fetchQuizHistory() {
        const token = localStorage.getItem('token');
        const container = document.getElementById('quizHistoryContainer');
        if (!token) {
            container.innerHTML = '<p>Please log in to view your quiz history.</p>';
            return;
        }
        try {
            const response = await fetch('/api/quizzes/history', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            const data = await response.json();
            console.log('Quiz history:', data.history); // Debug output
            if (data.success && data.history && data.history.length > 0) {
                container.innerHTML = data.history.map(result => {
                    const quizTitle = result.quiz && result.quiz.title ? result.quiz.title : 'N/A';
                    const role = result.role || 'N/A';
                    const gameMode = result.gameMode || 'N/A';
                    const score = typeof result.score === 'number' ? result.score : 'N/A';
                    const points = typeof result.pointsEarned === 'number' ? result.pointsEarned : 'N/A';
                    const date = result.completedAt ? new Date(result.completedAt).toLocaleString() : 'N/A';
                    const passed = result.passed ? true : false;
                    const badge = passed
                        ? '<span style="background:linear-gradient(90deg,#22c55e,#16a34a);color:white;padding:3px 12px;border-radius:12px;font-size:0.95em;margin-left:8px;">Passed</span>'
                        : '<span style="background:linear-gradient(90deg,#ef4444,#b91c1c);color:white;padding:3px 12px;border-radius:12px;font-size:0.95em;margin-left:8px;">Failed</span>';
                    const scoreColor = passed ? '#22c55e' : '#ef4444';
                    const icon = gameMode === 'contest' ? 'üèÜ' : 'üéÆ';
                    return `
                        <div class="card" style="margin-bottom: 18px; box-shadow:0 4px 16px rgba(34,197,94,0.08); border:2px solid #e5e7eb; border-radius:14px; padding:22px 28px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;">
                                <div style="font-size:1.5rem;">${icon}</div>
                                <div style="font-size:1.1rem;font-weight:600;color:#10b981;">${quizTitle}</div>
                                <div>${badge}</div>
                            </div>
                            <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:18px;font-size:1.05rem;">
                                <div><strong>Role:</strong> ${role.charAt(0).toUpperCase() + role.slice(1)}</div>
                                <div><strong>Mode:</strong> ${gameMode.charAt(0).toUpperCase() + gameMode.slice(1)}</div>
                                <div><strong>Score:</strong> <span style="color:${scoreColor};font-weight:700;">${score}%</span></div>
                                <div><strong>Points:</strong> <span style="color:#f59e42;font-weight:700;">${points}</span></div>
                                <div><strong>Date:</strong> ${date}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<p>No quiz history found yet.</p>';
            }
        } catch (error) {
            container.innerHTML = '<p>Error loading quiz history.</p>';
            console.error('Quiz history error:', error);
        }
    }

    async function fetchNotifications() {
        const token = localStorage.getItem('token');
        const notifBadge = document.getElementById('notifBadge');
        if (!token) {
            notifBadge.style.display = 'none';
            return [];
        }
        try {
            const response = await fetch('/api/notifications', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            const data = await response.json();
            if (data.success) {
                if (data.unreadCount > 0) {
                    notifBadge.textContent = data.unreadCount;
                    notifBadge.style.display = 'flex';
                } else {
                    notifBadge.style.display = 'none';
                }
                return data.notifications;
            } else {
                notifBadge.style.display = 'none';
                return [];
            }
        } catch (error) {
            notifBadge.style.display = 'none';
            return [];
        }
    }

    async function showNotificationPopup() {
        const popup = document.getElementById('notificationPopup');
        const notifList = document.getElementById('notificationList');
        popup.style.display = 'block';
        notifList.innerHTML = '<strong>Loading notifications...</strong>';
        const notifications = await fetchNotifications();
        if (notifications.length === 0) {
            notifList.innerHTML = '<p>No notifications yet.</p>';
        } else {
            notifList.innerHTML = notifications.map(n => `
                <div style="padding: 10px; border-bottom: 1px solid #e5e7eb; background: ${n.read ? '#fff' : '#f0fdf4'};">
                    <span style="font-weight: ${n.read ? 'normal' : 'bold'};">${n.message}</span><br>
                    <span style="font-size: 11px; color: #6b7280;">${new Date(n.createdAt).toLocaleString()}</span>
                </div>
            `).join('');
            // Mark all as read
            notifications.filter(n => !n.read).forEach(n => markNotificationRead(n._id));
        }
        setTimeout(() => {
            popup.style.display = 'none';
        }, 6000);
    }

    async function markNotificationRead(id) {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
            await fetch(`/api/notifications/${id}/read`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            // After marking as read, update badge
            fetchNotifications();
        } catch (error) {}
    }

    // Fetch notifications on login
    async function onLoginNotificationInit() {
        await fetchNotifications();
    }

    async function fetchProgressCategories() {
        const token = localStorage.getItem('token');
        const grid = document.getElementById('progressCategoryGrid');
        if (!token) return;
        try {
            const response = await fetch('/api/reports/learning-progress', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.success && data.learningProgress && data.learningProgress.progressDistribution) {
                const cats = data.learningProgress.progressDistribution;
                grid.innerHTML = cats.map(cat => `
                    <div class="category-card">
                        <h4>${cat._id}</h4>
                        <div class="count">${cat.count}</div>
                        <p>Avg Points: ${Math.round(cat.averagePoints || 0)}</p>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '<p>No data.</p>';
            }
        } catch (e) { grid.innerHTML = '<p>Error loading data.</p>'; }
    }

    async function fetchTop5Leaderboard() {
        const token = localStorage.getItem('token');
        const container = document.getElementById('top5Leaderboard');
        if (!token) return;
        try {
            const response = await fetch('/api/leaderboard/global', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.success && data.leaderboard) {
                container.innerHTML = data.leaderboard.slice(0,5).map((user, i) => `
                    <div class="leaderboard-item">
                        <div><span class="rank">${i+1}.</span> ${user.firstName} ${user.lastName}</div>
                        <div>${user.points.toLocaleString()} pts</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p>No leaderboard data.</p>';
            }
        } catch (e) { container.innerHTML = '<p>Error loading leaderboard.</p>'; }
    }

    async function fetchCertificate() {
        const token = localStorage.getItem('token');
        const certDiv = document.getElementById('certificateContent');
        if (!token) return;
        try {
            const response = await fetch('/api/certificates', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.success && data.certificates && data.certificates.length > 0) {
                const cert = data.certificates[data.certificates.length-1];
                certDiv.innerHTML = `
                    <h2>üèÜ Certificate of Achievement</h2>
                    <p>This certifies that</p>
                    <h3 style="color: #10b981; margin: 20px 0; font-size: 2.5rem;">${cert.name}</h3>
                    <p>has successfully completed the</p>
                    <h4 style="color: #065f46; margin: 15px 0;">Soft Skills Mastery Program</h4>
                    <div class="seal">üê¨</div>
                    <p>Awarded on: <strong>${new Date(cert.issuedAt).toLocaleDateString()}</strong></p>
                    <p style="margin-top: 20px;">Score: <strong>${cert.score}%</strong></p>
                    <a class="btn" href="${cert.certificateUrl}" target="_blank">Download Certificate</a>
                `;
            } else {
                certDiv.innerHTML = '<p>No certificates yet.</p>';
            }
        } catch (e) { certDiv.innerHTML = '<p>Error loading certificate.</p>'; }
    }

    function startTraining() {
        // Simulate clicking Practice Game and Student role
        selectGameMode('practice');
        setTimeout(() => {
            selectRole('student');
            setTimeout(() => {
                startGame();
            }, 300);
        }, 300);
    }

    async function renderManagerReports() {
        const token = localStorage.getItem('token');
        const summaryDiv = document.getElementById('managerReportsSummary');
        const detailsDiv = document.getElementById('managerReportsDetails');
        const progressDistChart = document.getElementById('progressDistChart').getContext('2d');
        const learningTrendsChart = document.getElementById('learningTrendsChart').getContext('2d');
        summaryDiv.innerHTML = 'Loading...';
        detailsDiv.innerHTML = '';
        if (!token) {
            summaryDiv.innerHTML = '<p>Please log in as a manager to view reports.</p>';
            return;
        }
        try {
            const response = await fetch('/api/reports/learning-progress', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (!data.success) throw new Error('Failed to fetch reports');
            const lp = data.learningProgress;
            // Summary stats
            const totalUsers = lp.progressDistribution.reduce((a, b) => a + b.count, 0);
            const avgCompletion = Math.round(
                lp.progressDistribution.reduce((a, b) => a + (b.count * parseInt(b._id.match(/\d+/g)[1] || 0)), 0) / (totalUsers || 1)
            );
            summaryDiv.innerHTML = `<div style='display:flex;gap:30px;justify-content:center;'>
                <div><strong>Total Users:</strong><br>${totalUsers}</div>
                <div><strong>Average Completion:</strong><br>${avgCompletion}%</div>
                <div><strong>Completed Training:</strong><br>${lp.completedTraining.length}</div>
            </div>`;
            // Progress Distribution Chart
            const distLabels = lp.progressDistribution.map(cat => cat._id);
            const distCounts = lp.progressDistribution.map(cat => cat.count);
            new Chart(progressDistChart, {
                type: 'bar',
                data: {
                    labels: distLabels,
                    datasets: [{
                        label: 'Users',
                        data: distCounts,
                        backgroundColor: ['#10b981','#22c55e','#84cc16','#f59e42']
                    }]
                },
                options: {responsive:true, plugins:{legend:{display:false}}}
            });
            // Learning Trends Chart
            const trendLabels = lp.learningTrends.map(t => `${t.month}/${t.year}`);
            const trendScores = lp.learningTrends.map(t => t.averageScore);
            const trendAttempts = lp.learningTrends.map(t => t.totalAttempts);
            new Chart(learningTrendsChart, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [
                        {label:'Avg Score',data:trendScores,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.2)',yAxisID:'y'},
                        {label:'Attempts',data:trendAttempts,borderColor:'#f59e42',backgroundColor:'rgba(245,158,66,0.2)',yAxisID:'y1'}
                    ]
                },
                options: {responsive:true, interaction:{mode:'index',intersect:false},
                    plugins:{legend:{display:true}},
                    scales:{y:{type:'linear',position:'left'},y1:{type:'linear',position:'right',grid:{drawOnChartArea:false}}}
                }
            });
            // Details (high performers, completed, etc.)
            let detailsHtml = '<h4>High Performers</h4><ul>';
            lp.highPerformers.forEach(u => {
                detailsHtml += `<li>${u.firstName || u.username} ${u.lastName || ''} - Avg Score: ${u.averageScore}, Quizzes: ${u.totalQuizzes}</li>`;
            });
            detailsHtml += '</ul>';
            detailsHtml += '<h4>Users Completed Training</h4><ul>';
            lp.completedTraining.forEach(u => {
                detailsHtml += `<li>${u.firstName || u.username} ${u.lastName || ''} - ${u.points} pts</li>`;
            });
            detailsHtml += '</ul>';
            detailsDiv.innerHTML = detailsHtml;
        } catch (e) {
            summaryDiv.innerHTML = '<p>Error loading manager reports.</p>';
            detailsDiv.innerHTML = '';
        }
    }

    const reportsTabBtn = document.querySelector('[data-tab="reports"]');
    if (reportsTabBtn) {
        reportsTabBtn.addEventListener('click', renderManagerReports);
    }

    // Select option for quiz answers
    function selectOption(questionIndex, optionIndex) {
        // Clear previous selections for this question
        const questionOptions = document.querySelectorAll(`input[name="question${questionIndex}"]`);
        questionOptions.forEach(input => {
            input.closest('.option').classList.remove('selected');
        });
        // Select the clicked option
        const optionDiv = Array.from(document.querySelectorAll(`input[name="question${questionIndex}"]`))[optionIndex].closest('.option');
        optionDiv.classList.add('selected');
        const radio = optionDiv.querySelector('input[type="radio"]');
        radio.checked = true;
    }
    </script>
</body>
</html>
